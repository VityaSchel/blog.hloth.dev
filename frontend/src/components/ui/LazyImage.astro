---
import type { ImageMetadata } from "astro";
import type { ComponentProps } from "astro/types";
import { Picture } from "astro:assets";
import { getLqip } from "$lib/get-image-as-buffer";

type Props = Pick<
	ComponentProps<typeof Picture>,
	"width" | "height" | "priority" | "class" | "alt"
> & {
	src: ImageMetadata;
	banner?: boolean;
	content?: boolean;
	zoomable?: boolean;
};

let {
	banner,
	class: className = "not-in-[.panorama]:rounded-lg",
	content,
	zoomable,
	...props
} = Astro.props;

let lqip: { src: string; width: number; height: number } = await getLqip(
	props.src.src,
	{
		origin: Astro.url.origin,
	},
);

let aspectRatio: number | null = null;
if (banner) {
	aspectRatio = 1.625 / 1;
} else if (props.src.width !== undefined && props.src.height !== undefined) {
	aspectRatio = props.src.width / props.src.height;
}

const Element = zoomable ? "a" : "div";

console.log(lqip.src);
---

<script>
	const onLoad = () => {
		const lazyImages = Array.from(document.querySelectorAll(".lazy-image"));
		for (const picture of lazyImages) {
			if (!(picture instanceof HTMLPictureElement)) continue;
			const img = picture.querySelector(":scope img");
			if (!(img instanceof HTMLImageElement)) continue;
			if (img.complete) {
				img.classList.remove("ph");
			} else {
				img.addEventListener("load", () => {
					img.classList.remove("ph");
				});
			}
		}
	};

	document.addEventListener("astro:page-load", onLoad);
	document.addEventListener("load", onLoad);
	onLoad();
</script>

<Element
	class:list={[
		`img-container relative max-w-full overflow-clip
		not-in-[.panorama]:rounded-lg`,
		{
			"max-h-[inherit]": content,
			"banner-clip relative h-auto w-full overflow-clip": banner,
			wide: aspectRatio != null && aspectRatio >= 680 / 500,
			landscape:
				aspectRatio != null && aspectRatio > 1 && aspectRatio < 680 / 500,
			portrait: aspectRatio != null && aspectRatio <= 1, //680 / 500,
		},
	]}
	style={aspectRatio != null ? `aspect-ratio: ${aspectRatio};` : undefined}
	{...zoomable
		? { href: props.src.src, target: "_blank", rel: "noopener noreferrer" }
		: {}}
	data-astro-prefetch={false}
>
	<Picture
		class:list={[
			{
				"h-full object-contain": content,
				"h-full w-full object-cover": banner,
			},
			`ph bg-cover text-[0px] backdrop-blur-2xl in-[.full-bleed]:h-full
			in-[.full-bleed]:w-auto`,
			className,
		]}
		style={`--ph: url("${lqip.src}"); --phw: ${lqip.width}px; --phh: ${lqip.height}px; --phar: ${
			lqip.width / lqip.height
		};`}
		densities={[1, 2]}
		formats={["avif", "webp"]}
		loading={props.priority ? "eager" : "lazy"}
		quality="high"
		pictureAttributes={{
			style: "mask: inherit;",
			class: "relative z-[2] lazy-image",
		}}
		{...props}
	/>
</Element>

<style>
	.ph {
		background-image: var(--ph);
	}
	.wide .ph,
	.landscape .ph {
		width: var(--phw);
		height: auto;
	}
	.portrait .ph {
		width: min(var(--phw), calc(var(--phar) * 500px));
		height: auto;
	}
</style>
