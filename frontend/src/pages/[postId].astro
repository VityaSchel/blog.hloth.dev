---
import { type CollectionEntry, getCollection, render } from "astro:content";
import PostPageLayout from "$layouts/PostPageLayout.astro";
import PageViews from "$components/post/PageViews.svelte";
import ReadNext from "$components/ReadNext.astro";
import { mapCollectionEntryToNavPostLink } from "$lib/nav-post-link";
import { components } from "$ui/content";

export async function getStaticPaths() {
	const posts = await getCollection("blog");
	return posts.map((post) => ({
		params: { postId: post.id },
		props: post,
	}));
}
type Props = CollectionEntry<"blog">;

const post = Astro.props;
const { Content } = await render(post);

const newerPost = await getCollection(
	"blog",
	({ data }) => data.createdAt.valueOf() >= post.data.createdAt.valueOf(),
)
	.then((posts) =>
		posts.sort(
			(a, b) => a.data.createdAt.valueOf() - b.data.createdAt.valueOf(),
		),
	)
	.then((posts) => posts.find(({ id }) => id !== post.id));

const olderPost = await getCollection(
	"blog",
	({ data }) => data.createdAt.valueOf() < post.data.createdAt.valueOf(),
)
	.then((posts) =>
		posts.sort(
			(a, b) => b.data.createdAt.valueOf() - a.data.createdAt.valueOf(),
		),
	)
	.then((posts) => posts.find(({ id }) => id !== post.id));
---

<PostPageLayout
	id={post.id}
	{...post.data}
	nextPost={mapCollectionEntryToNavPostLink(olderPost)}
>
	<Fragment slot="about-top">
		<PageViews postId={post.id} client:only="svelte" />
	</Fragment>
	<Content {components} />
	<ReadNext previous={newerPost} next={olderPost} slot="readNext" />
</PostPageLayout>
