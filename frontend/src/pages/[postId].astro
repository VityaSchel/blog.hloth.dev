---
import { type CollectionEntry, getCollection, render } from "astro:content";
import AppBar from "$components/AppBar.astro";
import PostPageLayout from "$layouts/PostPageLayout.astro";
import ReadTime from "$components/post/ReadTime.astro";
import PageViews from "$components/post/PageViews.svelte";
import PostTitle from "$components/post/PostTitle.astro";
import Category from "$ui/Category.astro";
import LazyImage from "$ui/LazyImage.astro";
import ReadNext from "$components/ReadNext.astro";
import { mapCollectionEntryToNavPostLink } from "$lib/nav-post-link";

export async function getStaticPaths() {
	const posts = await getCollection("blog");
	return posts.map((post) => ({
		params: { postId: post.id },
		props: post,
	}));
}
type Props = CollectionEntry<"blog">;

const post = Astro.props;
const { Content } = await render(post);

const newerPost = await getCollection(
	"blog",
	({ data }) => data.createdAt.valueOf() >= post.data.createdAt.valueOf(),
)
	.then((posts) =>
		posts.sort(
			(a, b) => a.data.createdAt.valueOf() - b.data.createdAt.valueOf(),
		),
	)
	.then((posts) => posts.find(({ id }) => id !== post.id));

const olderPost = await getCollection(
	"blog",
	({ data }) => data.createdAt.valueOf() < post.data.createdAt.valueOf(),
)
	.then((posts) =>
		posts.sort(
			(a, b) => b.data.createdAt.valueOf() - a.data.createdAt.valueOf(),
		),
	)
	.then((posts) => posts.find(({ id }) => id !== post.id));
---

<PostPageLayout id={post.id} {...post.data}>
	<AppBar
		homepage
		next={mapCollectionEntryToNavPostLink(olderPost)}
		slot="appbar"
	/>
	<Fragment slot="about-top">
		<Category category={post.data.category} />
		<ReadTime value={post.data.readTime} />
		<PageViews postId={post.id} client:only="svelte" />
	</Fragment>
	<Fragment slot="about-title">
		<PostTitle title={post.data.title} />
	</Fragment>
	<Fragment slot="banner">
		<LazyImage
			src={post.data.banner}
			alt={post.data.bannerAlt}
			layout="fixed"
			fit="fill"
			draggable={false}
			sizes="(max-width: 768px) 90vw, (max-width: 1168px) 36vw, 38vw"
			priority
			banner
		/>
		<!-- placeholder={banner.placeholder} -->
	</Fragment>
	<Content />
	<ReadNext previous={newerPost} next={olderPost} slot="readNext" />
</PostPageLayout>
