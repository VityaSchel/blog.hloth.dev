---
import { type CollectionEntry, getCollection, render } from "astro:content";
import AppBar from "$components/AppBar.astro";
import BlogPost from "$layouts/BlogPostLayout.astro";
import Me from "$components/post/Me.astro";
import ReadTime from "$components/post/ReadTime.astro";
import PageViews from "$components/post/PageViews.svelte";
import PostTitle from "$components/post/PostTitle.astro";
import PostDate from "$components/post/PostDate.astro";
import PostReactions from "$components/post/PostReactions.svelte";
import Category from "$ui/Category.astro";
import Separator from "$ui/Separator.astro";
import LazyImage from "$ui/LazyImage.astro";

export async function getStaticPaths() {
	const posts = await getCollection("blog");
	return posts.map((post) => ({
		params: { postId: post.id },
		props: post,
	}));
}
type Props = CollectionEntry<"blog">;

const post = Astro.props;
const { Content } = await render(post);

const nextPost = await getCollection(
	"blog",
	({ data }) => data.createdAt.valueOf() <= post.data.createdAt.valueOf(),
)
	.then((posts) =>
		posts.sort(
			(a, b) => b.data.createdAt.valueOf() - a.data.createdAt.valueOf(),
		),
	)
	.then((posts) => posts.find(({ id }) => id !== post.id));
---

<BlogPost {...post.data}>
	<AppBar
		homepage
		next={nextPost && {
			path: nextPost.id,
			title: nextPost.data.title,
		}}
	/>
	<article class="pt-16">
		<div class="flex flex-col-reverse items-start justify-between md:flex-row">
			<div
				class="flex flex-col gap-8 self-stretch md:max-w-[50%] md:flex-[50%]"
			>
				<div class="flex items-center gap-5">
					<Category category={post.data.category} />
					<ReadTime value={post.data.readTime} />
					<PageViews postId={post.id} client:only="svelte" />
				</div>
				<PostTitle title={post.data.title} />
				<Me />
			</div>
			<div
				class="banner-clip relative mb-8
					w-full overflow-clip md:mb-0 md:w-auto md:max-w-[40%] md:flex-[40%]"
			>
				<LazyImage
					src={post.data.banner}
					alt={post.data.bannerAlt}
					layout="fixed"
					fit="fill"
					draggable={false}
					sizes="(max-width: 768px) 90vw, (max-width: 1168px) 36vw, 38vw"
					priority
					banner
				/>
				<!-- placeholder={banner.placeholder} -->
			</div>
		</div>
		<Separator />
		<div class="flex w-full justify-center">
			<div class="article-content w-full max-w-[680px] break-words">
				<Content />
			</div>
		</div>
		<div class="flex w-full justify-center">
			<div class="flex w-full max-w-[680px] flex-col">
				<div
					class="mt-16 flex w-full flex-col justify-between gap-2 md:mt-8
						md:flex-row md:items-center"
				>
					<PostDate date={post.data.createdAt}>Published at:</PostDate>
					{
						post.data.updatedAt !== undefined && (
							<PostDate date={post.data.updatedAt}>Updated at:</PostDate>
						)
					}
				</div>
				<PostReactions postId={post.id} client:only="svelte" />
			</div>
		</div>
	</article>
</BlogPost>
